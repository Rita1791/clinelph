<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clinelph | Patient Card</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5ed7">

  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/patient.css">
  <link rel="stylesheet" href="css/visits.css">
</head>

<body>

<header class="app-header">
  <div class="logo">Clinelph</div>
  <div class="study-info">Patient Card</div>
  <div class="user-info">
    <span id="userRole"></span>
    <button onclick="logoutUser()">Logout</button>
  </div>
</header>

<div class="container">

  <!-- TIMELINE -->
  <aside class="timeline">
    <h3>Visit Timeline</h3>
    <ul>
      <li id="v1" onclick="openVisit(1)">Visit 1 – Screening</li>
      <li id="v2" onclick="openVisit(2)">Visit 2 – Baseline</li>
      <li id="v3" onclick="openVisit(3)">Visit 3 – Test Treatment 1</li>
      <li id="v4" onclick="openVisit(4)">Visit 4 – Baseline</li>
      <li id="v5" onclick="openVisit(5)">Visit 5 – Test Treatment 2</li>
    </ul>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <section class="patient-summary">
      <h2>Patient ID: <span id="patientId"></span></h2>
      <p>Status: <span id="patientStatus"></span></p>
      <p>Current Visit: <span id="currentVisit"></span></p>
    </section>

    <section class="visit-tabs">
      <button onclick="showTab('screening')">Screening</button>
      <button onclick="showTab('checkin')">Check-in</button>
      <button onclick="showTab('checkout')">Check-out</button>
      <button onclick="showTab('withdrawal')">Withdrawal</button>
    </section>

    <section id="tabContent" class="tab-content"></section>

  </main>
</div>

<!-- JS FILES (ORDER MATTERS) -->
<script src="js/db.js"></script>
<script src="js/auth.js"></script>
<script src="js/patient.js"></script>
<script src="js/visits.js"></script>
<script src="js/validation.js"></script>

<script>
/* --------- PAGE INIT --------- */

const user = requireAuth();
document.getElementById("userRole").innerText = user.role;

const selectedPatientId = sessionStorage.getItem("selectedPatientId");
if (!selectedPatientId) {
  alert("No patient selected");
  window.location.href = "patient.html";
}

let activeVisitNumber = null;

document.addEventListener("DOMContentLoaded", async () => {
  await openDatabase();

  const patient = await getPatient(selectedPatientId);
  if (!patient) {
    alert("Patient not found");
    window.location.href = "patient.html";
    return;
  }

  document.getElementById("patientId").innerText = patient.patientId;
  document.getElementById("patientStatus").innerText = patient.status;
  document.getElementById("currentVisit").innerText = patient.currentVisit;

  activeVisitNumber = patient.currentVisit;
  highlightTimeline(activeVisitNumber);
  openVisit(activeVisitNumber);
});

/* --------- TIMELINE --------- */

function highlightTimeline(current) {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById("v" + i);
    el.className = i < current ? "done" : i === current ? "active" : "";
  }
}

/* --------- VISIT NAV --------- */

async function openVisit(visitNumber) {
  activeVisitNumber = visitNumber;
  const visit = await loadVisit(selectedPatientId, visitNumber);

  if (!visit) {
    document.getElementById("tabContent").innerHTML =
      "<p>Visit not initialized yet.</p>";
    return;
  }

  visit.visitNumber === 1 ? loadScreeningTab() : loadCheckInTab();
}

function showTab(tab) {
  if (tab === "screening") loadScreeningTab();
  if (tab === "checkin") loadCheckInTab();
  if (tab === "checkout") loadCheckOutTab();
  if (tab === "withdrawal") loadWithdrawalTab();
}

/* --------- TABS --------- */

function loadScreeningTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Visit 1 – Screening</h3>
    <label>Ninhydrin OD</label>
    <input id="ninhydrin" type="number" step="0.01">
    <label>Pregnancy Test</label>
    <select id="pregnancy">
      <option>Negative</option>
      <option>Positive</option>
    </select>
    <button onclick="submitScreening()">Save Screening</button>
  `;
}

async function submitScreening() {
  const visit = await loadVisit(selectedPatientId, 1);
  const patient = await getPatient(selectedPatientId);

  try {
    await saveScreeningData(visit, {
      ninhydrin: parseFloat(document.getElementById("ninhydrin").value),
      pregnancyTest: document.getElementById("pregnancy").value,
      gender: patient.gender
    });
    alert("Screening completed");
    location.reload();
  } catch (e) {
    alert(e.message);
  }
}

function loadCheckInTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Visit ${activeVisitNumber} – Check-in</h3>
    <label>Brushing Time</label>
    <input id="brushTime" type="datetime-local">
    <label>Sample Time</label>
    <input id="sampleTime" type="datetime-local">
    <button onclick="submitCheckIn()">Save Check-in</button>
  `;
}

async function submitCheckIn() {
  const visit = await loadVisit(selectedPatientId, activeVisitNumber);
  try {
    await saveCheckIn(visit, {
      brushingTime: document.getElementById("brushTime").value,
      sampleTime: document.getElementById("sampleTime").value
    });
    alert("Check-in saved");
  } catch (e) {
    alert(e.message);
  }
}

function loadCheckOutTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Visit ${activeVisitNumber} – Check-out</h3>
    <label>Sample Collected At</label>
    <input id="sampleCollectedAt" type="datetime-local">
    <label>Analysis Time</label>
    <input id="analysisAt" type="datetime-local">
    <button onclick="submitCheckOut()">Complete Visit</button>
  `;
}

async function submitCheckOut() {
  const visit = await loadVisit(selectedPatientId, activeVisitNumber);
  try {
    await saveCheckOut(visit, {
      sampleCollectedAt: document.getElementById("sampleCollectedAt").value,
      analysisAt: document.getElementById("analysisAt").value
    });
    alert("Visit completed");
    location.reload();
  } catch (e) {
    alert(e.message);
  }
}

function loadWithdrawalTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Withdraw Patient</h3>
    <textarea id="withdrawReason"></textarea>
    <button onclick="withdraw()">Confirm Withdrawal</button>
  `;
}

async function withdraw() {
  await withdrawPatient(selectedPatientId,
    document.getElementById("withdrawReason").value);
  alert("Patient withdrawn");
  location.reload();
}
</script>

</body>
</html>
