<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clinelph | Patient Card</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
</head>

<body>

<nav class="navbar navbar-dark bg-primary px-3">
  <span class="navbar-brand">
    <img src="assets/logo.png" height="30"> Clinelph
  </span>
  <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
</nav>

<div class="container-fluid mt-3">
  <div class="row">

    <!-- LEFT -->
    <div class="col-md-3">
      <div class="card mb-3">
        <div class="card-body">
          <h6>Patient Summary</h6>
          <p><b>ID:</b> <span id="pid"></span></p>
          <p><b>Status:</b> <span id="pstatus" class="status orange"></span></p>
          <p><b>Current Visit:</b> <span id="currentVisit"></span></p>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6>Visit Timeline</h6>
          <button class="list-group-item" onclick="openVisit(1)">Visit 1 – Screening</button>
          <button class="list-group-item" onclick="openVisit(2)">Visit 2 – Baseline</button>
          <button class="list-group-item" onclick="openVisit(3)">Visit 3 – Test Treatment 1</button>
          <button class="list-group-item" onclick="openVisit(4)">Visit 4 – Baseline (Crossover)</button>
          <button class="list-group-item" onclick="openVisit(5)">Visit 5 – Test Treatment 2</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-md-9">
      <div id="alertBox"></div>

      <div id="visitPanel" class="card p-4 mb-3">
        <p class="text-muted">Select a visit from the timeline.</p>
      </div>
    </div>

  </div>
</div>

<script src="js/auth.js"></script>
<script src="js/db.js"></script>
<script src="js/crf.js"></script>

<script>
requireAuth();

document.addEventListener("DOMContentLoaded", () => {
  const patientId = sessionStorage.getItem("pid");

  if (!patientId) {
    alert("No patient selected. Redirecting.");
    window.location.href = "patient.html";
    return;
  }

  openDB().then(() => loadPatient(patientId));
});

async function loadPatient(patientId) {
  const patients = await getAllRecords("patients");
  const visits = await getAllRecords("visits");

  const p = patients.find(x => x.patientId === patientId);
  if (!p) {
    alert("Patient not found");
    window.location.href = "patient.html";
    return;
  }

  document.getElementById("pid").innerText = p.patientId;
  document.getElementById("currentVisit").innerText = p.currentVisit;

  const s = document.getElementById("pstatus");
  s.innerText = p.status;
  s.className = "status " +
    (p.status === "Completed" ? "green" :
     p.status === "Withdrawn" ? "red" : "orange");

  console.log("Patient OK:", p);
  console.log("Visits OK:", visits.filter(v => v.patientId === patientId));
}

function openVisit(v) {
  document.getElementById("visitPanel").innerHTML = `
    <h5>Visit ${v}</h5>
    <p>This visit panel is now working.</p>
  `;
}
</script>

</body>
</html>
