<!DOCTYPE html>
<html>
<head>
  <title>Clinelph | Patient Card</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<header>
  <img src="assets/logo.png">
  <b>Clinelph – Patient Screening</b>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

<div class="card">
  <h3>Patient Summary</h3>
  <p>ID: <span id="pid"></span></p>
  <p>Status: <span id="status"></span></p>
</div>

<div class="card">
  <h3>Visit 1 – Screening</h3>

  <label>Screening Date & Time</label>
  <input type="datetime-local" id="screeningDate">

  <label>Age</label>
  <input type="number" id="age">

  <label>Gender</label>
  <select id="gender">
    <option>Male</option>
    <option>Female</option>
  </select>

  <label>Inclusion Criteria</label>
  <select id="inclusion">
    <option value="true">Pass</option>
    <option value="false">Fail</option>
  </select>

  <label>Exclusion Criteria</label>
  <select id="exclusion">
    <option value="true">Pass</option>
    <option value="false">Fail</option>
  </select>

  <label>Blood Pressure</label>
  <input id="bp">

  <label>Pulse</label>
  <input id="pulse">

  <label>Fasting Glucose</label>
  <input id="glucose">

  <label>Urine Pregnancy Test Result</label>
  <select id="pregnancyResult">
    <option>Negative</option>
    <option>Positive</option>
  </select>

  <label>Ninhydrin OD</label>
  <input type="number" step="0.01" id="ninhydrinOD">

  <button onclick="submitScreening()">Save Screening</button>
</div>

<div class="card">
  <h3>Adverse Event</h3>
  <textarea id="aeDesc" placeholder="Describe adverse event"></textarea>
  <select id="aeSeverity">
    <option>Mild</option>
    <option>Moderate</option>
    <option>Severe</option>
  </select>
  <button onclick="saveAE()">Report AE</button>
</div>

<div class="card">
  <h3>Withdrawal</h3>
  <textarea id="withdrawReason"></textarea>
  <button class="danger" onclick="withdraw()">Withdraw Patient</button>
</div>

<div id="msg"></div>

</div>

<script src="js/auth.js"></script>
<script src="js/db.js"></script>
<script src="js/crf.js"></script>

<script>
requireAuth();
const pid = sessionStorage.getItem("pid");
document.getElementById("pid").innerText = pid;

openDB().then(loadPatient);

async function loadPatient() {
  const patients = await getAllRecords("patients");
  const p = patients.find(x => x.patientId === pid);
  document.getElementById("status").innerText = p.status;
}

async function submitScreening() {
  const form = {
    screeningDate: screeningDate.value,
    age: +age.value,
    gender: gender.value,
    inclusion: inclusion.value === "true",
    exclusion: exclusion.value === "true",
    bp: bp.value,
    pulse: pulse.value,
    glucose: glucose.value,
    pregnancyResult: pregnancyResult.value,
    ninhydrinOD: +ninhydrinOD.value
  };

  const res = await saveScreeningCRF(pid, form);
  document.getElementById("msg").innerText =
    res.ok ? "Screening Passed" : "Screen Failed: " + res.reason;
}

async function saveAE() {
  await reportAE(pid, {
    description: aeDesc.value,
    severity: aeSeverity.value
  });
  alert("AE recorded");
}

async function withdraw() {
  await withdrawPatient(pid, withdrawReason.value);
  alert("Patient withdrawn");
}
</script>

</body>
</html>
