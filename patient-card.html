<div id="visit-tabs">
  <button onclick="openTab('screening')">Screening</button>
  <button onclick="openTab('checkin')">Check-in</button>
  <button onclick="openTab('checkout')">Check-out</button>
</div>

<div id="tab-content"></div>
<script>
let currentPatientId = sessionStorage.getItem("selectedPatientId");
let currentVisitNumber;

document.addEventListener("DOMContentLoaded", async () => {
  await openDatabase();
  const patient = await getPatient(currentPatientId);
  currentVisitNumber = patient.currentVisit;
  loadVisitForm(currentVisitNumber);
});
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clinelph | Patient Card</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5ed7">

  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/patient.css">
  <link rel="stylesheet" href="css/visits.css">
</head>

<body>

<!-- HEADER -->
<header class="app-header">
  <div class="logo">Clinelph</div>
  <div class="study-info">
    Study: <span id="studyCode"></span>
  </div>
  <div class="user-info">
    <span id="userRole"></span>
    <button onclick="logoutUser()">Logout</button>
  </div>
</header>

<!-- MAIN LAYOUT -->
<div class="container">

  <!-- LEFT: VISIT TIMELINE -->
  <aside class="timeline">
    <h3>Visit Timeline</h3>
    <ul>
      <li id="v1" onclick="openVisit(1)">Visit 1 – Screening</li>
      <li id="v2" onclick="openVisit(2)">Visit 2 – Baseline</li>
      <li id="v3" onclick="openVisit(3)">Visit 3 – Test Treatment 1</li>
      <li id="v4" onclick="openVisit(4)">Visit 4 – Baseline</li>
      <li id="v5" onclick="openVisit(5)">Visit 5 – Test Treatment 2</li>
    </ul>
  </aside>

  <!-- RIGHT: VISIT DETAILS -->
  <main class="content">

    <!-- PATIENT SUMMARY -->
    <section class="patient-summary">
      <h2>Patient ID: <span id="patientId"></span></h2>
      <p>Status: <span id="patientStatus"></span></p>
      <p>Current Visit: <span id="currentVisit"></span></p>
    </section>

    <!-- VISIT TABS -->
    <section class="visit-tabs">
      <button onclick="showTab('screening')">Screening</button>
      <button onclick="showTab('checkin')">Check-in</button>
      <button onclick="showTab('checkout')">Check-out</button>
      <button onclick="showTab('events')">Events</button>
      <button onclick="showTab('withdrawal')">Withdrawal</button>
    </section>

    <!-- TAB CONTENT -->
    <section id="tabContent" class="tab-content"></section>

  </main>
</div>

<!-- SCRIPTS -->
<script src="js/db.js"></script>
<script src="js/auth.js"></script>
<script src="js/patient.js"></script>
<script src="js/visits.js"></script>
<script src="js/validation.js"></script>
<script src="js/randomization.js"></script>

<script>
let selectedPatientId = sessionStorage.getItem("selectedPatientId");
let activeVisitNumber = null;

/* INITIAL LOAD */
document.addEventListener("DOMContentLoaded", async () => {
  await openDatabase();

  const user = getCurrentUser();
  document.getElementById("userRole").innerText = user.role;

  const study = getActiveStudy();
  document.getElementById("studyCode").innerText = study.studyCode;

  const patient = await getPatient(selectedPatientId);
  document.getElementById("patientId").innerText = patient.patientId;
  document.getElementById("patientStatus").innerText = patient.status;
  document.getElementById("currentVisit").innerText = patient.currentVisit;

  activeVisitNumber = patient.currentVisit;
  highlightTimeline(patient.currentVisit);

  openVisit(activeVisitNumber);
});

/* TIMELINE */
function highlightTimeline(currentVisit) {
  for (let i = 1; i <= 5; i++) {
    document.getElementById("v" + i).className =
      i < currentVisit ? "done" :
      i === currentVisit ? "active" : "";
  }
}

/* OPEN VISIT */
async function openVisit(visitNumber) {
  activeVisitNumber = visitNumber;
  const visit = await loadVisit(selectedPatientId, visitNumber);

  if (visit.visitNumber === 1) {
    loadScreeningTab(visit);
  } else {
    loadCheckInTab(visit);
  }
}

/* TAB SWITCH */
function showTab(tab) {
  if (tab === "screening") openVisit(activeVisitNumber);
  if (tab === "checkin") loadCheckInTab();
  if (tab === "checkout") loadCheckOutTab();
  if (tab === "events") loadEventTab();
  if (tab === "withdrawal") loadWithdrawalTab();
}

/* SCREENING TAB */
function loadScreeningTab(visit) {
  document.getElementById("tabContent").innerHTML = `
    <h3>Visit 1 – Screening</h3>

    <label>Ninhydrin OD</label>
    <input id="ninhydrin" type="number" step="0.01">

    <label>Pregnancy Test</label>
    <select id="pregnancy">
      <option value="Negative">Negative</option>
      <option value="Positive">Positive</option>
    </select>

    <button onclick="submitScreening()">Save Screening</button>
  `;
}

/* SUBMIT SCREENING */
async function submitScreening() {
  const visit = await loadVisit(selectedPatientId, 1);
  const patient = await getPatient(selectedPatientId);

  const data = {
    ninhydrin: parseFloat(document.getElementById("ninhydrin").value),
    pregnancyTest: document.getElementById("pregnancy").value,
    gender: patient.gender
  };

  try {
    await saveScreeningData(visit, data);
    alert("Screening passed. Visit 2 started.");
    location.reload();
  } catch (e) {
    alert(e.message);
  }
}

/* CHECK-IN TAB */
function loadCheckInTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Visit ${activeVisitNumber} – Check-in</h3>

    <label>Brushing Time</label>
    <input id="brushTime" type="datetime-local">

    <label>Sample Collection Time</label>
    <input id="sampleTime" type="datetime-local">

    <button onclick="submitCheckIn()">Save Check-in</button>
  `;
}

/* SUBMIT CHECK-IN */
async function submitCheckIn() {
  const visit = await loadVisit(selectedPatientId, activeVisitNumber);

  const data = {
    brushingTime: document.getElementById("brushTime").value,
    sampleTime: document.getElementById("sampleTime").value
  };

  try {
    await saveCheckIn(visit, data);
    alert("Check-in saved");
  } catch (e) {
    alert(e.message);
  }
}

/* CHECK-OUT TAB */
function loadCheckOutTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Visit ${activeVisitNumber} – Check-out</h3>

    <label>Sample Collected At</label>
    <input id="sampleCollectedAt" type="datetime-local">

    <label>Analysis Time</label>
    <input id="analysisAt" type="datetime-local">

    <button onclick="submitCheckOut()">Complete Visit</button>
  `;
}

/* SUBMIT CHECK-OUT */
async function submitCheckOut() {
  const visit = await loadVisit(selectedPatientId, activeVisitNumber);

  const data = {
    sampleCollectedAt: document.getElementById("sampleCollectedAt").value,
    analysisAt: document.getElementById("analysisAt").value
  };

  try {
    await saveCheckOut(visit, data);
    alert("Visit completed");
    location.reload();
  } catch (e) {
    alert(e.message);
  }
}

/* EVENTS TAB */
function loadEventTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Events</h3>
    <p>Events are auto-recorded on failure.</p>
  `;
}

/* WITHDRAWAL TAB */
function loadWithdrawalTab() {
  document.getElementById("tabContent").innerHTML = `
    <h3>Withdraw Patient</h3>
    <label>Reason</label>
    <textarea id="withdrawReason"></textarea>
    <button onclick="withdraw()">Confirm Withdrawal</button>
  `;
}

async function withdraw() {
  const reason = document.getElementById("withdrawReason").value;
  await withdrawPatient(selectedPatientId, reason);
  alert("Patient withdrawn");
  location.reload();
}
</script>

</body>
</html>
