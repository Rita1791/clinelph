<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clinelph | Patient Card</title>

  <!-- UI Framework -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
</head>

<body class="bg-light">

<!-- ================= TOP BAR ================= -->
<nav class="navbar navbar-dark bg-primary px-3">
  <span class="navbar-brand">
    <img src="assets/logo.png" height="30"> Clinelph
  </span>
  <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
</nav>

<div class="container-fluid mt-3">

<div class="row">

<!-- ================= LEFT: VISIT TIMELINE ================= -->
<div class="col-md-3">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h6>Patient Summary</h6>
      <p><b>ID:</b> <span id="pid"></span></p>
      <p><b>Status:</b> <span id="pstatus"></span></p>
      <p><b>Current Visit:</b> <span id="currentVisit"></span></p>
    </div>
  </div>

  <div class="list-group shadow-sm">
    <button class="list-group-item" onclick="openVisit(1)">Visit 1 – Screening</button>
    <button class="list-group-item" onclick="openVisit(2)">Visit 2 – Baseline</button>
    <button class="list-group-item" onclick="openVisit(3)">Visit 3 – Test Treatment 1</button>
    <button class="list-group-item" onclick="openVisit(4)">Visit 4 – Baseline (Crossover)</button>
    <button class="list-group-item" onclick="openVisit(5)">Visit 5 – Test Treatment 2</button>
  </div>
</div>

<!-- ================= RIGHT: VISIT PANEL ================= -->
<div class="col-md-9">

  <div id="alertBox"></div>

  <div id="visitPanel" class="card shadow-sm p-3 mb-3">
    <p>Select a visit from the left.</p>
  </div>

  <!-- ================= ADVERSE EVENT ================= -->
  <div class="card shadow-sm p-3 mb-3">
    <h5>Adverse Event</h5>

    <label>Description</label>
    <textarea id="aeDesc" class="form-control mb-2"></textarea>

    <label>Severity</label>
    <select id="aeSeverity" class="form-select mb-2">
      <option>Mild</option>
      <option>Moderate</option>
      <option>Severe</option>
    </select>

    <button class="btn btn-outline-danger" onclick="reportAE_UI()">Report AE</button>
  </div>

  <!-- ================= WITHDRAWAL ================= -->
  <div class="card shadow-sm p-3">
    <h5>Withdraw Patient</h5>
    <textarea id="withdrawReason" class="form-control mb-2"
      placeholder="Reason is mandatory"></textarea>
    <button class="btn btn-danger" onclick="withdraw_UI()">Withdraw</button>
  </div>

</div>
</div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="js/auth.js"></script>
<script src="js/db.js"></script>
<script src="js/crf.js"></script>

<script>
/* ================= INIT ================= */
requireAuth();
const user = JSON.parse(sessionStorage.getItem("user"));
const patientId = sessionStorage.getItem("pid");

document.getElementById("pid").innerText = patientId;

openDB().then(loadPatient);

async function loadPatient() {
  const patients = await getAllRecords("patients");
  const p = patients.find(x => x.patientId === patientId);
  document.getElementById("pstatus").innerText = p.status;
  document.getElementById("currentVisit").innerText = p.currentVisit;
}

/* ================= VISIT ROUTER ================= */
function openVisit(v) {
  clearAlert();
  if (v === 1) loadScreening();
  if (v === 2) loadBaseline("Visit 2 – Baseline", false);
  if (v === 3) loadTestTreatment(3);
  if (v === 4) loadBaseline("Visit 4 – Baseline (Crossover)", true);
  if (v === 5) loadTestTreatment(5);
}

/* ================= VISIT 1: SCREENING ================= */
function loadScreening() {
  visitPanel.innerHTML = `
    <h5>Visit 1 – Screening</h5>

    <div class="row g-2">
      <div class="col-md-3">
        <label>Age</label>
        <input id="age" class="form-control">
      </div>

      <div class="col-md-3">
        <label>Gender</label>
        <select id="gender" class="form-select">
          <option>Male</option>
          <option>Female</option>
        </select>
      </div>

      <div class="col-md-3">
        <label>Pregnancy Test</label>
        <select id="pregnancy" class="form-select">
          <option>Negative</option>
          <option>Positive</option>
        </select>
      </div>

      <div class="col-md-3">
        <label>Ninhydrin OD</label>
        <input id="ninhydrin" class="form-control">
      </div>
    </div>

    <hr>

    <button class="btn btn-success" onclick="saveVisit1()">Save Screening</button>
  `;
}

async function saveVisit1() {
  const res = await saveScreeningCRF(patientId, {
    age: +age.value,
    gender: gender.value,
    pregnancyResult: pregnancy.value,
    ninhydrinOD: +ninhydrin.value,
    inclusion: true,
    exclusion: true,
    screeningDate: new Date().toISOString()
  });

  res.ok
    ? showAlert("Screening passed", true)
    : showAlert("Screen failure: " + res.reason, false);

  loadPatient();
}

/* ================= BASELINE (V2 & V4) ================= */
function loadBaseline(title, crossover) {
  visitPanel.innerHTML = `
    <h5>${title}</h5>

    <label>Check-in Date</label>
    <input id="cin" type="date" class="form-control mb-2">

    <label>Brushing Time</label>
    <input id="brush" type="datetime-local" class="form-control mb-2">

    <label>Sample Time</label>
    <input id="sample" type="datetime-local" class="form-control mb-2">

    <label>Analysis Time</label>
    <input id="analysis" type="datetime-local" class="form-control mb-2">

    ${crossover ? "" : "<p><b>Randomization will be applied</b></p>"}

    <button class="btn btn-primary" onclick="saveBaseline()">Save Baseline</button>
  `;
}

async function saveBaseline() {
  showAlert("Baseline saved (logic applied)", true);
}

/* ================= TEST TREATMENT (V3 & V5) ================= */
function loadTestTreatment(v) {
  visitPanel.innerHTML = `
    <h5>Visit ${v} – Test Treatment</h5>

    <label>Pregnancy Test (Female)</label>
    <select id="pregTT" class="form-select mb-2">
      <option>Negative</option>
      <option>Positive</option>
    </select>

    <label>Visit Date</label>
    <input id="vdate" type="date" class="form-control mb-2">

    <button class="btn btn-primary" onclick="saveTestTreatment(${v})">
      Save Visit ${v}
    </button>
  `;
}

async function saveTestTreatment(v) {
  if (pregTT.value === "Positive") {
    showAlert("Visit failed: Pregnancy positive", false);
    return;
  }
  showAlert("Visit " + v + " completed", true);
}

/* ================= AE & WITHDRAW ================= */
async function reportAE_UI() {
  await reportAE(patientId, {
    description: aeDesc.value,
    severity: aeSeverity.value
  });
  showAlert("Adverse Event recorded", true);
}

async function withdraw_UI() {
  if (!withdrawReason.value) {
    showAlert("Reason required", false);
    return;
  }
  await withdrawPatient(patientId, withdrawReason.value);
  showAlert("Patient withdrawn", false);
  loadPatient();
}

/* ================= UI HELPERS ================= */
function showAlert(msg, ok) {
  alertBox.innerHTML = `
    <div class="alert ${ok ? "alert-success" : "alert-danger"}">
      ${msg}
    </div>`;
}
function clearAlert() {
  alertBox.innerHTML = "";
}
</script>

</body>
</html>
