<!DOCTYPE html>
<html>
<head>
  <title>Patient Card</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<div class="container">
<div class="card"><h3 id="pid"></h3></div>

<div class="card">
<button onclick="randomize()">Randomize</button>
<p id="product"></p>
</div>

<div class="card">
<textarea id="reason" placeholder="Reason for edit"></textarea>
<button onclick="save()">Save</button>
<button class="danger" onclick="remove()">Delete</button>
</div>

<div class="card">
<h4>QC / QA Comments</h4>
<textarea id="comment"></textarea>
<button onclick="addComment()">Add Comment</button>
<ul id="comments"></ul>
</div>
</div>

<script src="js/db.js"></script>
<script src="js/auth.js"></script>
<script src="js/randomization.js"></script>
<script>
requireAuth(); openDatabase().then(load);
const pid=sessionStorage.getItem("pid");

function load(){ document.getElementById("pid").innerText=pid; loadComments(); }

let prod=null;
function randomize(){ prod=randomizeProduct(); product.innerText=prod; }

function save(){
  if(!canEdit()||!reason.value) return alert("No permission or reason missing");
  addRecord("auditLogs",{action:"EDIT",patientId:pid,user:getCurrentUser().email,reason:reason.value,time:new Date().toISOString()});
}

function remove(){
  if(!canDelete()||!reason.value) return alert("No permission or reason missing");
  addRecord("auditLogs",{action:"DELETE",patientId:pid,user:getCurrentUser().email,reason:reason.value,time:new Date().toISOString()});
}

async function loadComments(){
  comments.innerHTML="";
  (await getAllRecords("comments")).filter(c=>c.patientId===pid)
  .forEach(c=>comments.innerHTML+=`<li>${c.user}: ${c.text}</li>`);
}

function addComment(){
  const r=getCurrentUser().role;
  if(!["QC","QA","PI"].includes(r)) return alert("No permission");
  addRecord("comments",{patientId:pid,user:getCurrentUser().email,role:r,text:comment.value,time:new Date().toISOString()});
  comment.value=""; loadComments();
}
</script>

</body>
</html>
