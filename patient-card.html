<!DOCTYPE html>
<html>
<head>
  <title>Clinelph | Patient Card</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<header class="app-header">
  <img src="assets/logo.png" height="40">
  <h3>Patient Card</h3>
  <button onclick="logoutUser()">Logout</button>
</header>

<div class="container">

  <!-- PATIENT SUMMARY -->
  <div class="card">
    <h3>Patient ID: <span id="pid"></span></h3>
    <p>Status: <span id="pstatus"></span></p>
    <p>Current Visit: <span id="currentVisit"></span></p>
  </div>

  <!-- VISIT TABS -->
  <div class="card tabs">
    <button onclick="openVisit(1)">Visit 1 – Screening</button>
    <button onclick="openVisit(2)">Visit 2 – Baseline</button>
    <button onclick="openVisit(3)">Visit 3 – Test Treatment 1</button>
    <button onclick="openVisit(4)">Visit 4 – Baseline</button>
    <button onclick="openVisit(5)">Visit 5 – Test Treatment 2</button>
  </div>

  <!-- VISIT CONTENT -->
  <div class="card" id="visitCard"></div>

  <!-- WITHDRAWAL -->
  <div class="card">
    <h4>Withdraw Patient</h4>
    <textarea id="withdrawReason" placeholder="Reason for withdrawal"></textarea>
    <button class="danger" onclick="withdrawPatient()">Withdraw</button>
  </div>

</div>

<script src="js/auth.js"></script>
<script src="js/db.js"></script>
<script src="js/visits.js"></script>
<script src="js/randomization.js"></script>

<script>
/* -------------------- INIT -------------------- */
const user = requireAuth();
const pid = sessionStorage.getItem("pid");

openDatabase().then(loadPatient);

async function loadPatient() {
  const patients = await getAllRecords("patients");
  const patient = patients.find(p => p.patientId === pid);

  document.getElementById("pid").innerText = pid;
  document.getElementById("pstatus").innerText = patient.status;
  document.getElementById("currentVisit").innerText = patient.currentVisit;

  openVisit(patient.currentVisit);
}

/* -------------------- VISIT HANDLER -------------------- */
async function openVisit(no) {
  const check = await canStartVisit(pid, no);
  const visit = await getVisit(pid, no);

  if (!check.ok) {
    visitCard.innerHTML = `
      <h4>${visit.visitName}</h4>
      <p class="status-error">${check.msg}</p>
    `;
    return;
  }

  if (no === 1) loadScreening(visit);
  else loadTreatment(visit);
}

/* -------------------- VISIT 1 – SCREENING -------------------- */
function loadScreening(v) {
  visitCard.innerHTML = `
    <h4>Visit 1 – Screening</h4>

    <label>Screening Date & Time</label>
    <input id="scrDate" type="datetime-local" value="${v.data.scrDate || ""}">

    <label>Blood Pressure</label>
    <input id="bp" value="${v.data.bp || ""}">

    <label>Pulse</label>
    <input id="pulse" value="${v.data.pulse || ""}">

    <label>Fasting Blood Glucose</label>
    <input id="glucose" value="${v.data.glucose || ""}">

    <label>Urine Pregnancy Test (Female)</label>
    <select id="preg">
      <option>Negative</option>
      <option>Positive</option>
    </select>

    <label>Ninhydrin OD</label>
    <input id="od" type="number" step="0.01" value="${v.data.od || ""}">

    <label>Eligibility</label>
    <select id="elig">
      <option value="Pass">Pass</option>
      <option value="Fail">Fail</option>
    </select>

    <button onclick="saveScreening()">Save Screening</button>
  `;
}

/* SAVE SCREENING */
async function saveScreening() {
  const visits = await getAllRecords("visits");
  const v = visits.find(x => x.patientId === pid && x.visitNo === 1);

  v.data = {
    scrDate: scrDate.value,
    bp: bp.value,
    pulse: pulse.value,
    glucose: glucose.value,
    pregnancy: preg.value,
    od: parseFloat(od.value),
    eligibility: elig.value
  };

  if (v.data.od <= 0.35 || v.data.eligibility === "Fail" || v.data.pregnancy === "Positive") {
    v.status = "Failed";
    updateRecord("visits", v);
    alert("Patient failed screening");
    return;
  }

  v.status = "Completed";
  v.visitDate = scrDate.value.split("T")[0];
  updateRecord("visits", v);

  const patients = await getAllRecords("patients");
  const p = patients.find(p => p.patientId === pid);
  p.currentVisit = 2;
  updateRecord("patients", p);

  alert("Screening passed");
  location.reload();
}

/* -------------------- VISITS 2–5 -------------------- */
function loadTreatment(v) {
  visitCard.innerHTML = `
    <h4>${v.visitName}</h4>

    <label>Check-in Date & Time</label>
    <input id="checkin" type="datetime-local" value="${v.data.checkin || ""}">

    <label>Brushing Time</label>
    <input id="brush" type="datetime-local" value="${v.data.brush || ""}">

    <label>Sample Collection Time</label>
    <input id="sample" type="datetime-local" value="${v.data.sample || ""}">

    <label>Product Assigned</label>
    <input id="product" readonly value="${v.data.product || ""}">

    <button onclick="doRandomize()">Randomize Product</button>

    <label>Breakfast (Remarks)</label>
    <input id="breakfast" value="${v.data.breakfast || ""}">

    <label>Check-out Date & Time</label>
    <input id="checkout" type="datetime-local" value="${v.data.checkout || ""}">

    <button onclick="saveTreatment(${v.visitNo})">Save Visit</button>

    <p>Status:
      <span class="${v.status === 'Completed' ? 'status-ok' : 'status-pending'}">
        ${v.status}
      </span>
    </p>
  `;
}

function doRandomize() {
  product.value = randomizeProduct();
}

/* SAVE TREATMENT VISIT */
async function saveTreatment(no) {
  const visits = await getAllRecords("visits");
  const v = visits.find(x => x.patientId === pid && x.visitNo === no);

  v.data = {
    checkin: checkin.value,
    brush: brush.value,
    sample: sample.value,
    product: product.value,
    breakfast: breakfast.value,
    checkout: checkout.value
  };

  v.status = "Completed";
  v.visitDate = checkin.value.split("T")[0];
  updateRecord("visits", v);

  const patients = await getAllRecords("patients");
  const p = patients.find(p => p.patientId === pid);
  p.currentVisit = Math.min(no + 1, 5);
  updateRecord("patients", p);

  alert("Visit saved");
  location.reload();
}

/* -------------------- WITHDRAWAL -------------------- */
async function withdrawPatient() {
  if (!withdrawReason.value) {
    alert("Reason required");
    return;
  }

  const patients = await getAllRecords("patients");
  const p = patients.find(p => p.patientId === pid);
  p.status = "Withdrawn";
  updateRecord("patients", p);

  addRecord("auditLogs", {
    patientId: pid,
    action: "WITHDRAWAL",
    reason: withdrawReason.value,
    user: user.email,
    time: new Date().toISOString()
  });

  alert("Patient withdrawn");
  location.href = "patient.html";
}
</script>

</body>
</html>
