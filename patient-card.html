<!DOCTYPE html>
<html>
<head>
  <title>Patient Card</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<div class="container">

<div class="card">
  <h3>Patient: <span id="pid"></span></h3>
</div>

<div class="card tabs">
  <button onclick="loadVisit(1)">Visit 1</button>
  <button onclick="loadVisit(2)">Visit 2</button>
  <button onclick="loadVisit(3)">Visit 3</button>
  <button onclick="loadVisit(4)">Visit 4</button>
  <button onclick="loadVisit(5)">Visit 5</button>
</div>

<div class="card" id="visitCard"></div>

</div>

<script src="js/db.js"></script>
<script src="js/visits.js"></script>
<script src="js/auth.js"></script>

<script>
requireAuth();
openDatabase().then(init);

const pid = sessionStorage.getItem("pid");

function init() {
  document.getElementById("pid").innerText = pid;
  loadVisit(1);
}

async function loadVisit(no) {
  const visit = await getVisit(pid, no);

  visitCard.innerHTML = `
    <h4>${visit.visitName}</h4>

    <label>Visit Notes</label>
    <textarea id="notes">${visit.data.notes || ""}</textarea>

    <button onclick="saveVisit(${no})">Save Visit</button>
    <p>Status:
      <span class="${visit.status === 'Completed' ? 'status-ok':'status-pending'}">
        ${visit.status}
      </span>
    </p>
  `;
}

async function saveVisit(no) {
  const visit = await getVisit(pid, no);
  visit.data.notes = document.getElementById("notes").value;
  visit.status = "Completed";
  updateRecord("visits", visit);
  alert("Visit saved");
  loadVisit(no);
}
</script>

</body>
</html>
