<!-- only core part shown -->
<button onclick="registerPatient()">Register Patient</button>

<script>
async function registerPatient() {
  if (age.value < 18 || age.value > 60) {
    alert("Age must be between 18 and 60");
    return;
  }

  const patientId =
    PROTOCOL.code + "-MUM-" + new Date().getFullYear() + "-" + Math.floor(Math.random()*9000);

  addRecord("patients", {
    patientId,
    age: age.value,
    gender: gender.value,
    ethnicity: ethnicity.value,
    status: "Screening",
    currentVisit: 1
  });

  // initialize all visits immediately
  PROTOCOL.visits.forEach(v => {
    addRecord("visits", {
      patientId,
      visitNo: v.no,
      visitName: v.name,
      status: "Pending",
      visitDate: null,
      data: {}
    });
  });

  alert("Patient registered (Visit 1 created)");
}
</script>
