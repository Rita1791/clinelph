<!DOCTYPE html>
<html>
<head>
  <title>Patients</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<header>
  <img src="assets/logo.png">
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

<div class="card">
  <h3>Register Patient</h3>

  <input id="age" placeholder="Age">
  <select id="gender">
    <option>Male</option>
    <option>Female</option>
  </select>

  <select id="ethnicity">
    <option>Asian</option>
    <option>Caucasian</option>
  </select>

  <button onclick="register()">Register</button>
</div>

<div class="card">
  <h3>Patient List</h3>
  <table>
    <thead>
      <tr><th>ID</th><th>Status</th><th></th></tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>

</div>

<script src="js/auth.js"></script>
<script src="js/db.js"></script>
<script src="js/visits.js"></script>

<script>
requireAuth();

openDB().then(load);

function register() {
  if (age.value < 18 || age.value > 60) {
    alert("Age must be 18â€“60");
    return;
  }

  const pid = "CLP-" + Date.now();

  add("patients", {
    patientId: pid,
    age: age.value,
    gender: gender.value,
    ethnicity: ethnicity.value,
    status: "Active",
    currentVisit: 1
  });

  initVisits(pid);
  load();
}

async function load() {
  list.innerHTML = "";
  const patients = await getAll("patients");

  patients.forEach(p => {
    list.innerHTML += `
      <tr>
        <td>${p.patientId}</td>
        <td class="ok">${p.status}</td>
        <td>
          <button onclick="openCard('${p.patientId}')">Open</button>
        </td>
      </tr>
    `;
  });
}

function openCard(id) {
  sessionStorage.setItem("pid", id);
  location.href = "patient-card.html";
}
</script>

</body>
</html>
